# Микросервис для работы с балансом пользователей
## __[Тестовое задание на позицию стажера-бекендера](https://github.com/avito-tech/internship_backend_2022)__

### Используемые технологии:
* Язык разработки - __Go__
* Реляционная СУБД - __PostgreSQL__

### Основная функциональность по работе с балансом пользователей:

* __POST /balance/deposit__ - пополнение баланса пользователя

Пример тела запроса:
```json
{
    "user_id": 1,
    "amount": 1020,
	  "details": "премия"
}
```

Пример ответа сервера:
```json
{
    "message": "1020.00 were successfully deposited to user bank account"
}
```

* __POST /balance/reservation__ - резервирование с депозитного счета на резервный

Пример тела запроса:
```json
{
  "user_id": 1,
	"service_id": 1,
	"order_id": 1,
	"amount": 100,
	"details": "для покупки воды"
}
```

Пример ответа сервера:
```json
{
    "message": "100.00 were successfully reserved from user deposit account"
}
```

* __POST /balance/confession__ - подтверждение списания с резервного счёта

Пример тела запроса:
```json
{
  "user_id": 1,
	"service_id": 1,
	"order_id": 1,
	"amount": 100,
	"details": "для покупки воды"
}
```

Пример ответа сервера:
```json
{
    "message": "100.00 were successfully take from user reserve account"
}
```


* __POST /balance/transfer__ - перевод между пользователями (отправитель - пользователь с :user_id, получатель - в теле запроса) 

Пример тела запроса:
```json
{
  "from_user_id" : 1,
	"to_user_id": 2,
	"amount": 1000.99,
	"details": "купи воды"
}
```

Пример ответа сервера:
```json
{
    "message": "1000.99 were successfully transferred between users"
}
```

### Дополнительные задания:
1) Реализовать метод для получения месячного отчета. На вход: год-месяц. На выходе ссылка на CSV файл.

* __GET /bank_account/users/:user_id/balance?currency=USD__ 

Пример тела запроса:
```json
{
    "year": 2022
    "month": 11
}
```

Пример ответа сервера:
```json
{
    "path": "report_2022_11.csv"
}
```


2) Необходимо предоставить метод получения списка транзакций с комментариями откуда и зачем были начислены/списаны средства с баланса. Необходимо предусмотреть пагинацию и сортировку по сумме и дате.
* __GET /balance/transactions?sort=date__ - выдача истории транзакций.
Возможный параметры: __?sort=amount__ - ответ сортируется по сумме или __?sort=date__ - ответ сортируется по дате

---

### Дополнительная функциональность для работы с пользователями:

* __Post /users/create-user__ - Изначально в базе отсутствуют пользователи, необходимо добавить

Пример ответа сервера:
```json
{
    "id": 1
}
```

* __GET /users__ - просмотр всех существующих пользователей в системе. <br>

Пример ответа сервера:
```json
[   
    {
        "id": 1,
        "depocit_account": 1001.23,
        "reserve_account": 100 
    },
    {
        "id": 2,
        "depocit_account": 0,
        "reserve_account": 0 
    }
]
``` 

---

### Примечания к проекту:
* Архитектура REST API
* Фреймворк [gin-gonic/gin](https://github.com/gin-gonic/gin)
* Чистая архитектура (handler -> service -> repository)
* Для работы с БД используется пакет [sqlx](https://github.com/jmoiron/sqlx). Генерация файлов миграций. 
* Docker, Docker-compose, Makefile 
* Конфигурация приложения с помощью пакета [viper]("https://github.com/spf13/viper"). Работа с переменными окружения.
* Graceful Shutdown
* В БД и внутри структур языка Go баланс обрабатывается с точностью до двух знаков
* Приложение запускается на порту 8080
* Тестирование проводилось через Postman

### Схема БД:
Представлена полноценная и достаточная схема для выполнения данного задания

__users <-> transaction - one-to-many __

![db-schema](https://github.com/Allswbr/balance-service/blob/master/images/schema_db.jpg)

---


### Для запуска приложения используется docker-compose, вызов команд описан в makefile:

```
make build && make run
```

Если приложение запускается впервые, требуется также применить команду для миграции БД:

```
make migrate-up
```
---


### После дедлайна работа будет продолжаться в сторону улучшения:

1) загрузка collections с Postman
2) Рефакторинг кода
3) Облегчение docker-compose
4) Внедрение более реалистичной бизнес-логики с представленым описанием пользователей, услуг и для достижения третьей нормальной формы будет внедрена таблица с заказами, чтобы избежать связи многие ко многим.
